<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì‹¤ì‹œê°„ GPS ì´ë™ ê²½ë¡œ ì¶”ì  ì•±</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f0f4f8; /* ë°ì€ ë°°ê²½ìƒ‰ */
      }
      canvas {
        border: 2px solid #cbd5e1; /* ìº”ë²„ìŠ¤ í…Œë‘ë¦¬ */
        background-color: #ffffff; /* ìº”ë²„ìŠ¤ ë°°ê²½ìƒ‰ */
        display: block;
        margin: 0 auto;
        max-width: 95%; /* ìº”ë²„ìŠ¤ ìµœëŒ€ ë„ˆë¹„ */
        height: 400px; /* ê³ ì • ë†’ì´ */
        border-radius: 12px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* ê·¸ë¦¼ì íš¨ê³¼ */
        touch-action: none; /* í„°ì¹˜ ìŠ¤í¬ë¡¤ ë°©ì§€ */
      }
      /* ë©”ì‹œì§€ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
      .message-box {
        background-color: #fff;
        border: 1px solid #ccc;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
      }
    </style>
  </head>
  <body class="flex flex-col items-center justify-center min-h-screen p-4">
    <!-- ë©”ì‹œì§€ ë°•ìŠ¤ -->
    <div id="messageBox" class="message-box w-full max-w-lg mb-4 hidden"></div>

    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-lg">
      <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
        <span class="inline-block align-middle mr-2">ğŸ“</span>
        GPS ê²½ë¡œ ì¶”ì ê¸°
      </h1>

      <!-- ìº”ë²„ìŠ¤ ì»¨í…Œì´ë„ˆ -->
      <div class="flex justify-center mb-6">
        <canvas id="pathCanvas" width="800" height="400"></canvas>
      </div>

      <div class="text-center text-lg font-semibold text-gray-700 mb-4">
        ì´ë™ ê±°ë¦¬:
        <span id="distanceDisplay" class="text-blue-600">0.00</span> m
      </div>

      <div class="flex flex-wrap justify-center gap-4">
        <button
          id="startButton"
          class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105 min-w-[150px]">
          <span class="inline-block align-middle mr-2">â–¶ï¸</span> ì¶”ì  ì‹œì‘
        </button>
        <button
          id="stopButton"
          class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105 min-w-[150px]"
          disabled>
          <span class="inline-block align-middle mr-2">â¹ï¸</span> ì¶”ì  ì¤‘ì§€
        </button>
        <button
          id="clearButton"
          class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105 min-w-[150px]">
          <span class="inline-block align-middle mr-2">ğŸ—‘ï¸</span> ê²½ë¡œ ì§€ìš°ê¸°
        </button>
      </div>
      <p class="text-sm text-gray-500 text-center mt-4">
        * ì´ ì•±ì€ ì •í™•í•œ ì§€ë„ê°€ ì•„ë‹Œ ìƒëŒ€ì ì¸ ì´ë™ ê²½ë¡œë¥¼ ê·¸ë¦½ë‹ˆë‹¤.
        <br />* GPS ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
      </p>
    </div>

    <script>
      const canvas = document.getElementById('pathCanvas');
      const ctx = canvas.getContext('2d');
      const startButton = document.getElementById('startButton');
      const stopButton = document.getElementById('stopButton');
      const clearButton = document.getElementById('clearButton');
      const distanceDisplay = document.getElementById('distanceDisplay');
      const messageBox = document.getElementById('messageBox');

      let watchId = null; // GPS ì¶”ì ì„ ìœ„í•œ watchPosition ID
      let pathPoints = []; // {lat, lon} ê°ì²´ ë°°ì—´ë¡œ ê²½ë¡œ ì €ì¥
      let totalDistance = 0; // ì´ ì´ë™ ê±°ë¦¬ (ë¯¸í„°)
      let lastKnownPosition = null; // ë§ˆì§€ë§‰ìœ¼ë¡œ ì•Œë ¤ì§„ GPS ìœ„ì¹˜

      // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì • í•¨ìˆ˜
      function resizeCanvas() {
        // ë¶€ëª¨ ì»¨í…Œì´ë„ˆì˜ ë„ˆë¹„ì— ë§ì¶° ìº”ë²„ìŠ¤ ë„ˆë¹„ ì„¤ì •
        const parentWidth = canvas.parentElement.clientWidth;
        canvas.width = Math.min(parentWidth, 800); // ìµœëŒ€ 800px ë˜ëŠ” ë¶€ëª¨ ë„ˆë¹„
        // ë†’ì´ëŠ” ê³ ì • ìœ ì§€ (CSSì—ì„œ ì„¤ì •)
        // canvas.height = 400; // ë˜ëŠ” ë™ì ìœ¼ë¡œ ì„¤ì •
        drawPath(); // ìº”ë²„ìŠ¤ í¬ê¸°ê°€ ë³€ê²½ë˜ë©´ ê²½ë¡œë¥¼ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
      }

      // ì´ˆê¸° ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì • ë° ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      window.addEventListener('resize', resizeCanvas);
      resizeCanvas(); // í˜ì´ì§€ ë¡œë“œ ì‹œ í•œ ë²ˆ ì‹¤í–‰

      // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
      function showMessage(message, type = 'info') {
        messageBox.textContent = message;
        messageBox.className = 'message-box w-full max-w-lg mb-4 block'; // ì´ˆê¸°í™”
        if (type === 'error') {
          messageBox.classList.add(
            'bg-red-100',
            'text-red-700',
            'border-red-400',
          );
        } else if (type === 'success') {
          messageBox.classList.add(
            'bg-green-100',
            'text-green-700',
            'border-green-400',
          );
        } else {
          // info
          messageBox.classList.add(
            'bg-blue-100',
            'text-blue-700',
            'border-blue-400',
          );
        }
        // 3ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        setTimeout(() => {
          messageBox.classList.add('hidden');
        }, 5000);
      }

      // ë„ë¥¼ ë¼ë””ì•ˆìœ¼ë¡œ ë³€í™˜
      function toRadians(deg) {
        return (deg * Math.PI) / 180;
      }

      // Haversine ê³µì‹ì„ ì‚¬ìš©í•˜ì—¬ ë‘ ìœ„ë„/ê²½ë„ ì§€ì  ê°„ì˜ ê±°ë¦¬ ê³„ì‚° (ë¯¸í„°)
      function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // ì§€êµ¬ì˜ ë°˜ì§€ë¦„ (ë¯¸í„°)
        const Ï†1 = toRadians(lat1);
        const Ï†2 = toRadians(lat2);
        const Î”Ï† = toRadians(lat2 - lat1);
        const Î”Î» = toRadians(lon2 - lon1);

        const a =
          Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
          Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        const d = R * c; // ë¯¸í„° ë‹¨ìœ„
        return d;
      }

      // ìœ„ë„/ê²½ë„ í¬ì¸íŠ¸ë¥¼ ìº”ë²„ìŠ¤ ì¢Œí‘œë¡œ ë³€í™˜
      function getCanvasCoordinates(point, minLat, maxLat, minLon, maxLon) {
        if (pathPoints.length < 2) {
          // ì´ˆê¸° ì§€ì  ë˜ëŠ” ë‹¨ì¼ ì§€ì ì˜ ê²½ìš°, ìº”ë²„ìŠ¤ ì¤‘ì•™ì— ë°°ì¹˜
          return {x: canvas.width / 2, y: canvas.height / 2};
        }

        const latRange = maxLat - minLat;
        const lonRange = maxLon - minLon;

        // ìº”ë²„ìŠ¤ì— ê²½ë¡œê°€ ë„ˆë¬´ ì‘ê²Œ ê·¸ë ¤ì§€ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ìµœì†Œ ë²”ìœ„ ì„¤ì •
        const minEffectiveRange = 0.0001; // ì•½ 10-20 ë¯¸í„°
        const effectiveLatRange = Math.max(latRange, minEffectiveRange);
        const effectiveLonRange = Math.max(lonRange, minEffectiveRange);

        // ìº”ë²„ìŠ¤ì— ê½‰ ì°¨ê²Œ ê·¸ë¦¬ê¸° ìœ„í•œ ìŠ¤ì¼€ì¼ íŒ©í„° ê³„ì‚°
        // ì—¬ë°±ì„ ì£¼ê¸° ìœ„í•´ 0.95 ì‚¬ìš© (5% ì—¬ë°±)
        const scaleX = (canvas.width * 0.95) / effectiveLonRange;
        const scaleY = (canvas.height * 0.95) / effectiveLatRange;
        const scale = Math.min(scaleX, scaleY);

        // ìº”ë²„ìŠ¤ ì¤‘ì•™ì— ê²½ë¡œë¥¼ ë°°ì¹˜í•˜ê¸° ìœ„í•œ ì˜¤í”„ì…‹ ê³„ì‚°
        const renderedWidth = effectiveLonRange * scale;
        const renderedHeight = effectiveLatRange * scale;
        const offsetX = (canvas.width - renderedWidth) / 2;
        const offsetY = (canvas.height - renderedHeight) / 2;

        // ìœ„ë„(y)ëŠ” ìº”ë²„ìŠ¤ì—ì„œ ì•„ë˜ë¡œ ê°ˆìˆ˜ë¡ ê°’ì´ ì»¤ì§€ë¯€ë¡œ, ìœ„ë„ ê°’ì„ ë°˜ì „
        const x = (point.lon - minLon) * scale + offsetX;
        const y = (maxLat - point.lat) * scale + offsetY;

        return {x, y};
      }

      // ìº”ë²„ìŠ¤ì— ê²½ë¡œ ê·¸ë¦¬ê¸°
      function drawPath() {
        ctx.clearRect(0, 0, canvas.width, canvas.height); // ìº”ë²„ìŠ¤ ì§€ìš°ê¸°

        if (pathPoints.length === 0) {
          return;
        }

        // ê²½ë¡œì˜ ìµœì†Œ/ìµœëŒ€ ìœ„ë„ ë° ê²½ë„ ì°¾ê¸°
        let minLat = pathPoints[0].lat,
          maxLat = pathPoints[0].lat;
        let minLon = pathPoints[0].lon,
          maxLon = pathPoints[0].lon;

        for (const p of pathPoints) {
          minLat = Math.min(minLat, p.lat);
          maxLat = Math.max(maxLat, p.lat);
          minLon = Math.min(minLon, p.lon);
          maxLon = Math.max(maxLon, p.lon);
        }

        ctx.beginPath();
        ctx.strokeStyle = '#007bff'; // ì„  ìƒ‰ìƒ (íŒŒë€ìƒ‰)
        ctx.lineWidth = 4; // ì„  ë‘ê»˜

        // ì²« ë²ˆì§¸ ì§€ì ì„ ê¸°ì¤€ìœ¼ë¡œ ê²½ë¡œ ì‹œì‘
        const startCoords = getCanvasCoordinates(
          pathPoints[0],
          minLat,
          maxLat,
          minLon,
          maxLon,
        );
        ctx.moveTo(startCoords.x, startCoords.y);

        // ëª¨ë“  ê²½ë¡œ ì§€ì ì„ ì—°ê²°
        for (let i = 1; i < pathPoints.length; i++) {
          const currentCoords = getCanvasCoordinates(
            pathPoints[i],
            minLat,
            maxLat,
            minLon,
            maxLon,
          );
          ctx.lineTo(currentCoords.x, currentCoords.y);
        }
        ctx.stroke();

        // ì‹œì‘ì ê³¼ ëì ì— ì› ê·¸ë¦¬ê¸°
        ctx.fillStyle = '#28a745'; // ì‹œì‘ì  (ë…¹ìƒ‰)
        ctx.beginPath();
        ctx.arc(startCoords.x, startCoords.y, 6, 0, Math.PI * 2);
        ctx.fill();

        if (pathPoints.length > 1) {
          const endCoords = getCanvasCoordinates(
            pathPoints[pathPoints.length - 1],
            minLat,
            maxLat,
            minLon,
            maxLon,
          );
          ctx.fillStyle = '#dc3545'; // ëì  (ë¹¨ê°„ìƒ‰)
          ctx.beginPath();
          ctx.arc(endCoords.x, endCoords.y, 6, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      // GPS ìœ„ì¹˜ ì„±ê³µ ì½œë°± í•¨ìˆ˜
      function successCallback(position) {
        const {latitude, longitude} = position.coords;
        const newPoint = {lat: latitude, lon: longitude};

        if (lastKnownPosition) {
          // ì´ì „ ì§€ì ê³¼ì˜ ê±°ë¦¬ ê³„ì‚°
          const distanceSegment = haversineDistance(
            lastKnownPosition.latitude,
            lastKnownPosition.longitude,
            latitude,
            longitude,
          );
          totalDistance += distanceSegment;
        }

        pathPoints.push(newPoint);
        lastKnownPosition = position.coords;

        distanceDisplay.textContent = totalDistance.toFixed(2); // ì†Œìˆ˜ì  ë‘ ìë¦¬ê¹Œì§€ í‘œì‹œ

        drawPath(); // ê²½ë¡œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        showMessage(
          `ìƒˆë¡œìš´ ìœ„ì¹˜: ìœ„ë„ ${latitude.toFixed(5)}, ê²½ë„ ${longitude.toFixed(
            5,
          )}`,
          'info',
        );
      }

      // GPS ìœ„ì¹˜ ì‹¤íŒ¨ ì½œë°± í•¨ìˆ˜
      function errorCallback(error) {
        let errorMessage = '';
        switch (error.code) {
          case error.PERMISSION_DENIED:
            errorMessage =
              'ìœ„ì¹˜ ì •ë³´ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ì•±ì„ ì‚¬ìš©í•˜ë ¤ë©´ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage =
              'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GPS ì‹ í˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
            break;
          case error.TIMEOUT:
            errorMessage =
              'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
            break;
          case error.UNKNOWN_ERROR:
            errorMessage = 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            break;
        }
        showMessage(`ì˜¤ë¥˜: ${errorMessage}`, 'error');
        stopTracking(); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¶”ì  ì¤‘ì§€
      }

      // ì¶”ì  ì‹œì‘ í•¨ìˆ˜
      function startTracking() {
        if (!navigator.geolocation) {
          showMessage(
            'ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” GPS ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
            'error',
          );
          return;
        }

        if (watchId === null) {
          // ìœ„ì¹˜ ê°ì‹œ ì‹œì‘ (ë§¤ 2ì´ˆë§ˆë‹¤, ê³ ì •ë°€ë„)
          watchId = navigator.geolocation.watchPosition(
            successCallback,
            errorCallback,
            {
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0,
            },
          );
          startButton.disabled = true;
          stopButton.disabled = false;
          showMessage('GPS ì¶”ì ì„ ì‹œì‘í•©ë‹ˆë‹¤...', 'success');
        }
      }

      // ì¶”ì  ì¤‘ì§€ í•¨ìˆ˜
      function stopTracking() {
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
          startButton.disabled = false;
          stopButton.disabled = true;
          showMessage('GPS ì¶”ì ì„ ì¤‘ì§€í•©ë‹ˆë‹¤.', 'info');
        }
      }

      // ê²½ë¡œ ì§€ìš°ê¸° í•¨ìˆ˜
      function clearPath() {
        stopTracking(); // ê²½ë¡œ ì§€ìš°ê¸° ì „ì— ì¶”ì  ì¤‘ì§€
        pathPoints = [];
        totalDistance = 0;
        lastKnownPosition = null;
        distanceDisplay.textContent = totalDistance.toFixed(2);
        drawPath(); // ìº”ë²„ìŠ¤ ì§€ìš°ê¸°
        showMessage('ê²½ë¡œì™€ ê±°ë¦¬ë¥¼ ì§€ì› ìŠµë‹ˆë‹¤.', 'info');
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
      startButton.addEventListener('click', startTracking);
      stopButton.addEventListener('click', stopTracking);
      clearButton.addEventListener('click', clearPath);

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë©”ì‹œì§€ í‘œì‹œ
      window.onload = () => {
        if (navigator.geolocation) {
          showMessage(
            "ì•„ë˜ 'ì¶”ì  ì‹œì‘' ë²„íŠ¼ì„ ëˆŒëŸ¬ GPS ì¶”ì ì„ ì‹œì‘í•˜ì„¸ìš”.",
            'info',
          );
        } else {
          showMessage(
            'ì´ ë¸Œë¼ìš°ì €ëŠ” ì§€ì˜¤ë¡œì¼€ì´ì…˜(GPS)ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
            'error',
          );
        }
      };
    </script>
  </body>
</html>
